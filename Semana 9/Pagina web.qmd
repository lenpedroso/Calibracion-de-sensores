---
title: "Calibración de sensores de bajo costo para medir MP2,5"
author: "Lenna Pedroso Noris"
format: html
editor: visual
---

## SINCA

El **Sistema de Información Nacional de Calidad del Aire(SINCA)** presenta aproximadamente 12 estaciones de monotoreo en la ciudad lo que limita la determinacion espacial de los contaminates de la ciudad y ppr ende la exposicion real de la poblacion <https://sinca.mma.gob.cl/>.

## Sensores de bajo costo

Los sensores de bajo costo para medir la concentracion de material particulado han tenido gran aceptacion en los ultimps años debido a su bajo costo, accequibilidad y bajo consumo energetico.

## Calibración de los sensores

Una de las principales desventajas de la utilizacion de sensores de bajo costo como complemeto de la red actual de monitoreo es su calibracion ya que los datos obtenidos por el sensor presentan alta incertidumbre.
# Grafico de timevariation
Para verificar el comportamiento de los sensores y su comparacion con los monitpres de referencia se realiza un grafico de time variation
```{r}

#Cargar datos
Condes_Plantawer_SINCA <- read.csv2("data/Condes_Plantawer_SINCA.csv", header = TRUE)
# Cargar librerias
library(openair)
# Modificar fecha 

Condes_Plantawer_SINCA$Fecha<-Condes_Plantawer_SINCA$Fecha+ 20000000
Condes_Plantawer_SINCA$Hora<-Condes_Plantawer_SINCA$Hora/100
Condes_Plantawer_SINCA$Hora<-paste(Condes_Plantawer_SINCA$Hora,"00",sep=":",collapse = NULL)
Condes_Plantawer_SINCA$date<-paste(Condes_Plantawer_SINCA$Fecha, Condes_Plantawer_SINCA$Hora,sep = " ", collapse = NULL)
Condes_Plantawer_SINCA$date <- as.POSIXct(Condes_Plantawer_SINCA$date, format = "%Y%m%d %H:%M", tz = "Etc/GMT+4")

# Time variation 
timeVariation(mydata = Condes_Plantawer_SINCA, 
              pollutant = c("PM25_P1", "PM25_P2", "PM25_P3", "PM25_P4", "PM25_P5", "PM25_SINCA"), 
              main = "Time variation Plantawer vs Sinca en Las Condes",
              ylab = expression(PM[2.5]~" (" * mu * "g/" * m^3 * ")") 
)

```

```{r}
#| echo: true
#| message: false
#| warning: false

Column_pm <- c("PM25_P1", "PM25_P2", "PM25_P3", "PM25_P4", "PM25_P5", "PM25_Sinca")

Column_pm <- intersect(Column_pm, names(Condes_Plantawer_SINCA))

CONboxplot <- Condes_Plantawer_SINCA %>% 
  pivot_longer(
    cols = all_of(Column_pm),
    names_to = "Sensores",
    values_to = "PM25"
  ) %>%
  mutate(Sensores = factor(
    Sensores,
    levels = c(paste0("PM25_P", 1:5), "PM25_Sinca"),
    labels = c("P1", "P2", "P3", "P4", "P5", "SINCA")
  ))

 
 # Box plot

ggplot(CONboxplot, aes(x = Sensores,
                        y = PM25, fill = Sensores)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 21) +
  labs(x = "Sensores", y = expression(PM[2.5]~" (" * mu * "g/" * m^3 * ")"), 
       title = "Comparacion Plantawe vs SINCA") +
  theme_bw(base_size = 13) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "none")


```

```{r}
#| echo: false
#| message: false
#| warning: false
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggpmisc) 

# para mostrar ecuación y R² en el gráfico

df_long <- Condes_Plantawer_SINCA %>%
  select(starts_with("PM25_")) %>%
  pivot_longer(
    cols = PM25_P1:PM25_P5,
    names_to = "sensor",
    values_to = "PM25_P"
  )
datos_long <- datos_long %>% drop_na(PM25)

ggplot(df_long, aes(x = PM25_SINCA, y = PM25_P)) +
  geom_point(alpha = 0.5, color = "blue") +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  stat_poly_eq(
    aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
    formula = y ~ x,
    parse = TRUE,
    label.x.npc = "left",
    label.y.npc = 0.95,
    size = 3.5,
    color = "black"
  ) +
  facet_wrap(~ sensor, scales = "free") +
  labs(
    x = expression(PM[2.5]~SINCA~(mu*g/m^3)),
    y = expression(PM[2.5]~Plantower~(mu*g/m^3)),
    title = "Regresión lineal: Sensores Plantower (P1–P5) vs SINCA"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    strip.background = element_rect(fill = "lightgray"),
    panel.grid.minor = element_blank()
  )


```